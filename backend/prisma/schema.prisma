generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  role         UserRole     @default(DOCTOR)
  isVerified   Boolean      @default(false)
  refreshToken String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  doctor       Doctor?
  institution  Institution?
  patient      Patient?

  @@map("users")
}

model Doctor {
  id                    String                  @id @default(uuid())
  userId                String                  @unique
  fullName              String
  crm                   String
  crmState              String                  @db.VarChar(2)
  crmVerified           Boolean                 @default(false)
  phone                 String?
  bio                   String?
  profilePicUrl         String?
  graduationYear        Int?
  universityName        String?
  city                  String?
  state                 String?                 @db.VarChar(2)
  latitude              Float?
  longitude             Float?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  appointments          Appointment[]
  caseComments          CaseComment[]
  caseParticipations    CaseParticipant[]
  caseStudies           CaseStudy[]
  receivedConnections   ConnectionRequest[]     @relation("ReceivedConnections")
  sentConnections       ConnectionRequest[]     @relation("SentConnections")
  courseEnrollments     CourseEnrollment[]
  instructedCourses     Course[]
  availabilities        DoctorAvailability[]
  careerProgress        DoctorCareerProgress[]
  certifications        DoctorCertification[]
  experiences           DoctorExperience[]
  skills                DoctorSkill[]
  specialties           DoctorSpecialty[]
  workplaces            DoctorWorkplace[]
  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventAttendances      EventAttendee[]
  eventSpeakerAt        EventSpeaker[]
  jobApplications       JobApplication[]
  menteeShips           Mentorship[]            @relation("MenteeMentorships")
  mentorships           Mentorship[]            @relation("MentorMentorships")
  publications          PublicationAuthor[]
  projectMemberships    ResearchProjectMember[]
  studyGroupMemberships StudyGroupMember[]

  @@unique([crm, crmState])
  @@index([city, state])
  @@index([fullName])
  @@map("doctors")
}

model Specialty {
  id             String                 @id @default(uuid())
  name           String                 @unique
  code           String                 @unique
  careerPaths    CareerPath[]
  caseStudies    CaseStudy[]
  certifications Certification[]
  doctors        DoctorSpecialty[]
  jobs           Job[]
  publications   PublicationSpecialty[]
  studyGroups    StudyGroup[]

  @@map("specialties")
}

model DoctorSpecialty {
  id          String    @id @default(uuid())
  doctorId    String
  specialtyId String
  isPrimary   Boolean   @default(false)
  rqeNumber   String?
  doctor      Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  specialty   Specialty @relation(fields: [specialtyId], references: [id])

  @@unique([doctorId, specialtyId])
  @@map("doctor_specialties")
}

model Skill {
  id      String        @id @default(uuid())
  name    String        @unique
  doctors DoctorSkill[]

  @@map("skills")
}

model DoctorSkill {
  id       String @id @default(uuid())
  doctorId String
  skillId  String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  skill    Skill  @relation(fields: [skillId], references: [id])

  @@unique([doctorId, skillId])
  @@map("doctor_skills")
}

model DoctorExperience {
  id            String       @id @default(uuid())
  doctorId      String
  institutionId String?
  role          String
  description   String?
  startDate     DateTime
  endDate       DateTime?
  isCurrent     Boolean      @default(false)
  doctor        Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  institution   Institution? @relation(fields: [institutionId], references: [id])

  @@map("doctor_experiences")
}

model Institution {
  id            String             @id @default(uuid())
  adminUserId   String             @unique
  name          String
  type          InstitutionType
  cnpj          String?            @unique
  phone         String?
  email         String?
  website       String?
  description   String?
  logoUrl       String?
  street        String?
  number        String?
  complement    String?
  neighborhood  String?
  city          String
  state         String             @db.VarChar(2)
  zipCode       String?
  latitude      Float?
  longitude     Float?
  isVerified    Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  profilePicUrl String?
  experiences   DoctorExperience[]
  events        Event[]
  adminUser     User               @relation(fields: [adminUserId], references: [id])
  jobs          Job[]

  @@index([city, state])
  @@index([type])
  @@map("institutions")
}

model Job {
  id            String           @id @default(uuid())
  institutionId String
  title         String
  type          JobType
  description   String
  requirements  String?
  salaryMin     Float?
  salaryMax     Float?
  shift         JobShift
  city          String
  state         String           @db.VarChar(2)
  specialtyId   String?
  isActive      Boolean          @default(true)
  startsAt      DateTime?
  expiresAt     DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  applications  JobApplication[]
  institution   Institution      @relation(fields: [institutionId], references: [id])
  specialty     Specialty?       @relation(fields: [specialtyId], references: [id])

  @@index([city, state])
  @@index([type])
  @@index([specialtyId])
  @@index([isActive, createdAt])
  @@map("jobs")
}

model JobApplication {
  id          String            @id @default(uuid())
  jobId       String
  doctorId    String
  status      ApplicationStatus @default(PENDING)
  coverLetter String?
  appliedAt   DateTime          @default(now())
  respondedAt DateTime?
  doctor      Doctor            @relation(fields: [doctorId], references: [id])
  job         Job               @relation(fields: [jobId], references: [id])

  @@unique([jobId, doctorId])
  @@map("job_applications")
}

model ConnectionRequest {
  id         String           @id @default(uuid())
  senderId   String
  receiverId String
  status     ConnectionStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  receiver   Doctor           @relation("ReceivedConnections", fields: [receiverId], references: [id])
  sender     Doctor           @relation("SentConnections", fields: [senderId], references: [id])

  @@unique([senderId, receiverId])
  @@map("connection_requests")
}

model Publication {
  id              String                 @id @default(uuid())
  title           String
  abstract        String?
  doi             String?                @unique
  journal         String?
  publicationType PublicationType        @default(ARTICLE)
  publishDate     DateTime?
  keywords        String[]               @default([])
  externalUrl     String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  citations       Citation[]             @relation("PublicationCited")
  citedBy         Citation[]             @relation("PublicationCiting")
  authors         PublicationAuthor[]
  specialties     PublicationSpecialty[]

  @@index([title])
  @@index([publicationType])
  @@map("publications")
}

model PublicationAuthor {
  id            String      @id @default(uuid())
  publicationId String
  doctorId      String
  authorRole    AuthorRole  @default(CO_AUTHOR)
  authorOrder   Int         @default(1)
  doctor        Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  publication   Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)

  @@unique([publicationId, doctorId])
  @@map("publication_authors")
}

model Citation {
  id                String      @id @default(uuid())
  citingPubId       String
  citedPubId        String
  citedPublication  Publication @relation("PublicationCited", fields: [citedPubId], references: [id], onDelete: Cascade)
  citingPublication Publication @relation("PublicationCiting", fields: [citingPubId], references: [id], onDelete: Cascade)

  @@unique([citingPubId, citedPubId])
  @@map("citations")
}

model PublicationSpecialty {
  id            String      @id @default(uuid())
  publicationId String
  specialtyId   String
  publication   Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  specialty     Specialty   @relation(fields: [specialtyId], references: [id])

  @@unique([publicationId, specialtyId])
  @@map("publication_specialties")
}

model CaseStudy {
  id           String            @id @default(uuid())
  title        String
  description  String
  diagnosis    String?
  treatment    String?
  outcome      String?
  specialtyId  String?
  status       CaseStatus        @default(OPEN)
  isAnonymous  Boolean           @default(false)
  viewCount    Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  authorId     String
  comments     CaseComment[]
  participants CaseParticipant[]
  author       Doctor            @relation(fields: [authorId], references: [id])
  specialty    Specialty?        @relation(fields: [specialtyId], references: [id])

  @@index([status])
  @@index([specialtyId])
  @@map("case_studies")
}

model CaseParticipant {
  id        String    @id @default(uuid())
  caseId    String
  doctorId  String
  joinedAt  DateTime  @default(now())
  caseStudy CaseStudy @relation(fields: [caseId], references: [id], onDelete: Cascade)
  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([caseId, doctorId])
  @@map("case_participants")
}

model CaseComment {
  id        String    @id @default(uuid())
  caseId    String
  doctorId  String
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  caseStudy CaseStudy @relation(fields: [caseId], references: [id], onDelete: Cascade)
  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@map("case_comments")
}

model StudyGroup {
  id          String              @id @default(uuid())
  name        String
  description String?
  specialtyId String?
  isPublic    Boolean             @default(false)
  maxMembers  Int?
  memberCount Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  meetings    StudyGroupMeeting[]
  members     StudyGroupMember[]
  specialty   Specialty?          @relation(fields: [specialtyId], references: [id])

  @@index([specialtyId])
  @@index([isPublic])
  @@map("study_groups")
}

model StudyGroupMember {
  id         String         @id @default(uuid())
  groupId    String
  doctorId   String
  role       StudyGroupRole @default(MEMBER)
  joinedAt   DateTime       @default(now())
  doctor     Doctor         @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  studyGroup StudyGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, doctorId])
  @@map("study_group_members")
}

model StudyGroupMeeting {
  id          String     @id @default(uuid())
  groupId     String
  title       String
  description String?
  scheduledAt DateTime
  durationMin Int        @default(60)
  meetingUrl  String?
  isCompleted Boolean    @default(false)
  createdAt   DateTime   @default(now())
  studyGroup  StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([scheduledAt])
  @@map("study_group_meetings")
}

model ResearchProject {
  id            String                  @id @default(uuid())
  title         String
  description   String?
  status        ProjectStatus           @default(PLANNING)
  startDate     DateTime?
  endDate       DateTime?
  fundingSource String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  members       ResearchProjectMember[]

  @@index([status])
  @@map("research_projects")
}

model ResearchProjectMember {
  id        String          @id @default(uuid())
  projectId String
  doctorId  String
  role      ProjectRole     @default(RESEARCHER)
  joinedAt  DateTime        @default(now())
  doctor    Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  project   ResearchProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, doctorId])
  @@map("research_project_members")
}

model Certification {
  id                String                @id @default(uuid())
  name              String
  issuingBody       String
  certificationType CertificationType
  specialtyId       String?
  validityYears     Int?
  description       String?
  requirementsUrl   String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  specialty         Specialty?            @relation(fields: [specialtyId], references: [id])
  doctorCerts       DoctorCertification[]

  @@index([certificationType])
  @@index([issuingBody])
  @@map("certifications")
}

model DoctorCertification {
  id              String        @id @default(uuid())
  doctorId        String
  certificationId String
  issueDate       DateTime
  expiryDate      DateTime?
  certificateNum  String?
  isVerified      Boolean       @default(false)
  documentUrl     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  certification   Certification @relation(fields: [certificationId], references: [id])
  doctor          Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, certificationId])
  @@index([expiryDate])
  @@map("doctor_certifications")
}

model CareerPath {
  id               String                 @id @default(uuid())
  name             String
  description      String?
  specialtyId      String
  avgDurationYears Int?
  isOfficial       Boolean                @default(false)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  milestones       CareerMilestone[]
  specialty        Specialty              @relation(fields: [specialtyId], references: [id])
  progresses       DoctorCareerProgress[]

  @@index([specialtyId])
  @@map("career_paths")
}

model CareerMilestone {
  id           String                 @id @default(uuid())
  careerPathId String
  name         String
  description  String?
  orderNum     Int
  isRequired   Boolean                @default(true)
  typicalYears Int?
  createdAt    DateTime               @default(now())
  careerPath   CareerPath             @relation(fields: [careerPathId], references: [id], onDelete: Cascade)
  progresses   DoctorCareerProgress[]

  @@unique([careerPathId, orderNum])
  @@map("career_milestones")
}

model DoctorCareerProgress {
  id           String          @id @default(uuid())
  doctorId     String
  careerPathId String
  milestoneId  String
  status       String          @default("NOT_STARTED")
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  careerPath   CareerPath      @relation(fields: [careerPathId], references: [id], onDelete: Cascade)
  doctor       Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  milestone    CareerMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@unique([doctorId, careerPathId, milestoneId])
  @@map("doctor_career_progress")
}

model Mentorship {
  id        String           @id @default(uuid())
  mentorId  String
  menteeId  String
  status    MentorshipStatus @default(ACTIVE)
  startDate DateTime         @default(now())
  endDate   DateTime?
  goals     String?
  focusArea String?
  notes     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  mentee    Doctor           @relation("MenteeMentorships", fields: [menteeId], references: [id])
  mentor    Doctor           @relation("MentorMentorships", fields: [mentorId], references: [id])

  @@unique([mentorId, menteeId])
  @@index([status])
  @@map("mentorships")
}

model Topic {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  courses     CourseTopic[]
  events      EventTopic[]

  @@map("topics")
}

model Event {
  id            String          @id @default(uuid())
  title         String
  description   String?
  eventType     EventType
  status        EventStatus     @default(UPCOMING)
  startDate     DateTime
  endDate       DateTime?
  location      String?
  eventUrl      String?
  maxAttendees  Int?
  attendeeCount Int             @default(0)
  isOnline      Boolean         @default(false)
  isFree        Boolean         @default(true)
  price         Float?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  organizerId   String
  attendees     EventAttendee[]
  speakers      EventSpeaker[]
  topics        EventTopic[]
  organizer     Institution     @relation(fields: [organizerId], references: [id])

  @@index([startDate])
  @@index([eventType])
  @@index([status])
  @@map("events")
}

model EventTopic {
  id      String @id @default(uuid())
  eventId String
  topicId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  topic   Topic  @relation(fields: [topicId], references: [id])

  @@unique([eventId, topicId])
  @@map("event_topics")
}

model EventAttendee {
  id             String    @id @default(uuid())
  eventId        String
  doctorId       String
  registeredAt   DateTime  @default(now())
  attendedAt     DateTime?
  certificateUrl String?
  doctor         Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  event          Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, doctorId])
  @@map("event_attendees")
}

model EventSpeaker {
  id       String  @id @default(uuid())
  eventId  String
  doctorId String
  topic    String?
  orderNum Int     @default(1)
  doctor   Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  event    Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, doctorId])
  @@map("event_speakers")
}

model Course {
  id              String             @id @default(uuid())
  title           String
  description     String?
  instructorId    String
  status          CourseStatus       @default(DRAFT)
  durationHours   Int?
  level           String?
  price           Float?
  thumbnailUrl    String?
  enrollmentCount Int                @default(0)
  rating          Float?             @default(0)
  reviewCount     Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  enrollments     CourseEnrollment[]
  modules         CourseModule[]
  topics          CourseTopic[]
  instructor      Doctor             @relation(fields: [instructorId], references: [id])

  @@index([status])
  @@index([instructorId])
  @@map("courses")
}

model CourseModule {
  id          String  @id @default(uuid())
  courseId    String
  title       String
  description String?
  orderNum    Int
  durationMin Int?
  videoUrl    String?
  contentUrl  String?
  course      Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, orderNum])
  @@map("course_modules")
}

model CourseTopic {
  id       String @id @default(uuid())
  courseId String
  topicId  String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  topic    Topic  @relation(fields: [topicId], references: [id])

  @@unique([courseId, topicId])
  @@map("course_topics")
}

model CourseEnrollment {
  id             String           @id @default(uuid())
  courseId       String
  doctorId       String
  status         EnrollmentStatus @default(ENROLLED)
  progress       Int              @default(0)
  enrolledAt     DateTime         @default(now())
  completedAt    DateTime?
  certificateUrl String?
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  doctor         Doctor           @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([courseId, doctorId])
  @@map("course_enrollments")
}

model Patient {
  id            String        @id @default(uuid())
  userId        String        @unique
  fullName      String
  cpf           String?       @unique
  phone         String?
  dateOfBirth   DateTime?
  gender        String?       @db.VarChar(20)
  profilePicUrl String?
  city          String?
  state         String?       @db.VarChar(2)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  complement    String?
  neighborhood  String?
  number        String?
  street        String?
  zipCode       String?
  appointments  Appointment[]
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patients")
}

model DoctorWorkplace {
  id             String               @id @default(uuid())
  doctorId       String
  name           String
  street         String?
  number         String?
  complement     String?
  neighborhood   String?
  city           String
  state          String               @db.VarChar(2)
  zipCode        String?
  phone          String?
  latitude       Float
  longitude      Float
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  appointments   Appointment[]
  availabilities DoctorAvailability[]
  doctor         Doctor               @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_workplaces")
}

model DoctorAvailability {
  id              String          @id @default(uuid())
  doctorId        String
  workplaceId     String
  dayOfWeek       DayOfWeek
  startTime       String
  endTime         String
  slotDurationMin Int             @default(30)
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  doctor          Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  workplace       DoctorWorkplace @relation(fields: [workplaceId], references: [id], onDelete: Cascade)

  @@unique([doctorId, workplaceId, dayOfWeek, startTime])
  @@map("doctor_availabilities")
}

model Appointment {
  id           String            @id @default(uuid())
  patientId    String
  doctorId     String
  status       AppointmentStatus @default(PENDING)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  cancelReason String?
  cancelledAt  DateTime?
  durationMin  Int               @default(30)
  reason       String?
  scheduledAt  DateTime
  workplaceId  String
  type         AppointmentType   @default(PRESENCIAL)
  doctor       Doctor            @relation(fields: [doctorId], references: [id])
  patient      Patient           @relation(fields: [patientId], references: [id])
  workplace    DoctorWorkplace   @relation(fields: [workplaceId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([workplaceId])
  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

enum UserRole {
  DOCTOR
  INSTITUTION_ADMIN
  PATIENT
}

enum InstitutionType {
  HOSPITAL
  CLINICA
  UBS
  LABORATORIO
  PRONTO_SOCORRO
  CONSULTORIO
}

enum JobType {
  PLANTAO
  CONSULTA
}

enum JobShift {
  DIURNO
  NOTURNO
  INTEGRAL
  FLEXIVEL
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PublicationType {
  ARTICLE
  CASE_REPORT
  REVIEW
  BOOK_CHAPTER
  CONFERENCE_PAPER
}

enum AuthorRole {
  FIRST_AUTHOR
  CO_AUTHOR
  CORRESPONDING_AUTHOR
}

enum CaseStatus {
  OPEN
  DISCUSSION
  RESOLVED
  CLOSED
}

enum StudyGroupRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum ProjectRole {
  PRINCIPAL_INVESTIGATOR
  CO_INVESTIGATOR
  RESEARCHER
  ASSISTANT
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum CertificationType {
  MEDICAL_BOARD
  SPECIALTY
  SUBSPECIALTY
  CONTINUING_EDUCATION
  TECHNICAL
}

enum MentorshipStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

enum EventType {
  CONGRESS
  SYMPOSIUM
  WORKSHOP
  WEBINAR
  CONFERENCE
  MEETUP
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  DROPPED
}

enum AppointmentType {
  PRESENCIAL
  TELECONSULTA
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED_BY_PATIENT
  CANCELLED_BY_DOCTOR
  NO_SHOW
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}
